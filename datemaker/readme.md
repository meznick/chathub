# datemaker
Сервис для менеджмента действий, связанных юзеров: регистрация на ивент,
подтверждение регистрации, создание ивентов, менеджмент звонков внутри ивента
и тд.

## Разработка
Используется python 3.10, зависимости из requirements.txt.
Для запуска сервиса нужно подложить файл с 
[кредами](#подключение-к-google-cloud-meet-api).

Запуск в локальном интерпретаторе:
```shell
# подготовить файл .env: положить куда удобно, в моем примере это будет корень
# домашней диры (~/).
# активируем файл с переменными окружения
source ~/.env
# запускаем модуль
python -m datemaker --debug # дебаг опционально
# при разработке может быть полезно запускать какие-то классы по отдельности,
# в т.ч. нужно написать тесты
```

Запуск в докере в разработке.

Запуск через модуль питона в разработке.

## Деплой
Пока не ясно как будет удобнее: писать отдельный dockerfile для каждого из сервисов
или создать универсальный контейнер и в нем запускать python модули, так что
попробуем и то и другое, выберем что больше понравится.

## Интеграция в проект

---
Нужно обновить terraform в соответствии с этим описанием.

---
Этот сервис читает сообщения из очереди "datemaker_prod/dev" в RabbitMQ и выполняет
запросы в соответствии с сообщениями. Возможна отправка сообщений в очередь
"bot_prod/dev": если нужно запросить подтверждение регистрации, отправить ссылку
на подключение к конференции в GMeet.

Нужно настроить мониторинг для прометеуса. Метрики:
- цпу, память
- количество сообщений в очереди на вход
- количество обработанных сообщений
- количество запланированных ивентов
- количество активных конференций/звонков

Нужно настроить запись данных по ивентам в бд для последующей аналитики?
- статистика зарегистрированных на ивент/принявших/отклонивших?
- действия юзеров во время ивента: что конкретно?

## Бизнес логика

### Регистрация на ивент
Регистрация на ивент инициализируется со стороны пользователя, через чат или
мини-аппку. На стороне сервиса нужно добавить юзера в пул участников в
соответствии с его рейтингом.

Алгоритм:
1. юзер отправляет запрос на регистрацию
2. ему возвращается список ближайших ивентов
3. он выбирает подходящий ему
4. юзер записывается, ему отправляется сообщение что он записан

### Подтверждение регистрации
Перед проведением ивента (за Х часов) нужно провести опрос зарегистрировавшихся:
они должны подтвердить участие.
1. сервис собирает список участников, разослать запросы на подтверждение
2. определение "дивизионов": разбить список участников на группы по рейтингу
3. разослать уведомления о подтверждении ивента: набралось необходимое число подтверждений

### Создание новых ивентов
Для того чтобы было куда регистрировать пользователей, сервис должен заранее
по какому-то алгоритму создавать ивенты в определенное время. Пока никакой
умной логики я тут не придумал, так что нужно просто сформировать расписание
и автоматизировать заблаговременное создание сущностей в БД.

### Сохранение итогов ивента
Для улучшения системы рейтинга и обработки жалоб полезно сохранять "лог" дейтов.

Свериться с [документацией](https://developers.google.com/meet/api/guides/artifacts)
GMeet для выявления того что мы можем сохранять и продумать как мы это будем
использовать. Так же, нужно понять можем ли мы сохранять события прямо во время
ивента (хватит ли ресурсов), или получится запускать этот пайплайн сразу после
окончания ивента.

### Проведение ивента
На момент начала события уже должны быть готовы разбивка на дивизионы, разбивка
на пары.

Сценарий ивента:
1. третий шаг из подтверждения регистрации (по сути нулевой шаг)
2. за 5 минут до назначенного времени всем участникам рассылается напоминалка с правилами
   ивента, с инструкцией как все будет проходить.
3. в целевое время (либо по истечении таймера для опаздывающих)
   всем участникам скидываются корректные ссылки на их звонки в мите
4. каждые пять минут звонок в мите принудительно завершается
5. пауза 1 мин чтобы участники перекурили + записали что-то про партнера
6. высылается ссылка на созвон с новым партнером, с этого места п.3-5 повторяются
   до тех пор пока все друг с другом не заобщаются
7. подведение итогов -- выбор партнеров. конкретная механика пока под вопросом.

## Реализация
По каждому сценарию из бизнес-логики нужно описать как технически это реализуется
для того чтобы в дальнейшем самим не запутаться.

### Подключение к Google Cloud (Meet API)
Подключение происходит по 
[документации](https://developers.google.com/meet/api/guides/quickstart/python),
таким образом в дире /datemaker должно находиться 2 файла: `creds.json` + 
`token.json`. Постарайся их не добавить в гит, а то придется поебаться, но так-то
они добавлены в gitignore.
